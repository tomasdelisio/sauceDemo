package test_e2e;

import static org.testng.Assert.assertEquals;
import static org.testng.Assert.assertTrue;

import org.openqa.selenium.WebDriver;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;

import com.aventstack.extentreports.ExtentReports;
import com.aventstack.extentreports.ExtentTest;
import com.aventstack.extentreports.Status;

import data.Data;
import driver.Driver;
import pages.BasePage;
import pages.CartPage;
import pages.CheckoutPage;
import pages.ProductsPage;
import pages.LoginPage;
import pages.FinishPage;
import report.Report;
import utils.Messages;

public class TestE2E {
	/*** VARIABLES ***/
	// Driver
	private WebDriver driver = null;

	// Pages
	private BasePage basePage = null;
	private LoginPage loginPage = null;
	private ProductsPage productsPage = null;
	private CartPage cartPage = null;
	private CheckoutPage checkoutPage = null;
	private FinishPage finishPage = null;

	// URL
	private static final String URL = "https://www.saucedemo.com/v1/";
	
	// Messages Test
	private final String TEST_START = Messages.TEST_START.getMessage();
	private final String TEST_OK = Messages.TEST_OK.getMessage();
	private final String TEST_ERROR = Messages.TEST_ERROR.getMessage();
	private final String TEST_FINISH = Messages.TEST_FINISH.getMessage();
	private final String VALIDATE_TEST = Messages.VALIDATE_TEST.getMessage();
	
	// Messages Login
	private final String LOGIN_OK = Messages.LOGIN_OK.getMessage();
	private final String LOGIN = Messages.LOGIN.getMessage(); 
	private final String LOGIN_COMPLETED = Messages.LOGIN_COMPLETED.getMessage();
	private final String VALIDATE_LOGIN = Messages.VALIDATE_LOGIN.getMessage();
	
	// Messages Home
	private final String PRODUCT_ADDED = Messages.PRODUCT_ADDED.getMessage();
	
	// Messages Cart
	private final String CART = Messages.CART.getMessage(); 
	private final String CART_OK = Messages.CART_OK.getMessage();
	private final String CART_COMPLETED = Messages.CART_COMPLETED.getMessage();
	private final String VALIDATE_CART = Messages.VALIDATE_CART.getMessage();
	
	// Messages Checkout
	private final String CHECKOUT = Messages.CHECKOUT.getMessage();
	private final String CHECKOUT_OK = Messages.CHECKOUT_OK.getMessage();	
	private final String VALIDATE_CHECKOUT = Messages.VALIDATE_CHECKOUT.getMessage();
	
	// Messages Data
	private final String USR_COMPLETED = Messages.USR_COMPLETED.getMessage();
	private final String PASS_COMPLETED = Messages.PASS_COMPLETED.getMessage();
	private final String PRODUCTS_TXT_SAVED = Messages.PRODUCTS_TXT_SAVED.getMessage();
	private final String USR_MATCH = Messages.USR_MATCH.getMessage();
	private final String PASS_MATCH = Messages.PASS_MATCH.getMessage();
	private final String PRODUCTS_TXT_VISIBLE = Messages.PRODUCTS_TXT_VISIBLE.getMessage();
	private final String USR_MISMATCH = Messages.USR_MISMATCH.getMessage();
	private final String PASS_MISMATCH = Messages.PASS_MISMATCH.getMessage();
	private final String PRODUCTS_TXT_NOT_VISIBLE = Messages.PRODUCTS_TXT_NOT_VISIBLE.getMessage();
	private final String REMOVE_BTN_CLICKABLE = Messages.REMOVE_BTN_CLICKABLE.getMessage();
	private final String REMOVE_BTN_NOT_CLICKABLE = Messages.REMOVE_BTN_NOT_CLICKABLE.getMessage();
	private final String PRODUCT_NAME_MATCH = Messages.PRODUCT_NAME_MATCH.getMessage();
	private final String PRODUCT_NAME_MISMATCH = Messages.PRODUCT_NAME_MISMATCH.getMessage();
	private final String PRODUCT_DESCRIPTION_MATCH = Messages.PRODUCT_DESCRIPTION_MATCH.getMessage();
	private final String PRODUCT_DESCRIPTION_MISMATCH = Messages.PRODUCT_DESCRIPTION_MISMATCH.getMessage();
	private final String PRODUCT_PRICE_MATCH = Messages.PRODUCT_PRICE_MATCH.getMessage();
	private final String PRODUCT_PRICE_MISMATCH = Messages.PRODUCT_PRICE_MISMATCH.getMessage();
	private final String NAME_MATCH = Messages.PRODUCT_NAME_MATCH.getMessage();
	private final String NAME_MISMATCH = Messages.PRODUCT_NAME_MISMATCH.getMessage();
	private final String LASTNAME_MATCH = Messages.PRODUCT_DESCRIPTION_MATCH.getMessage();
	private final String LASTNAME_MISMATCH = Messages.PRODUCT_DESCRIPTION_MISMATCH.getMessage();
	private final String POSTAL_CODE_MATCH = Messages.PRODUCT_PRICE_MATCH.getMessage();
	private final String POSTAL_CODE_MISMATCH = Messages.PRODUCT_PRICE_MISMATCH.getMessage();
	private final String LOGIN_BTN_CLICKED = Messages.LOGIN_BTN_CLICKED.getMessage();
	private final String CART_BTN_CLICKED = Messages.CART_BTN_CLICKED.getMessage();
	private final String YOUR_CART_TXT_SAVED = Messages.YOUR_CART_TXT_SAVED.getMessage();
	private final String PRODUCT_NAME_SAVED = Messages.PRODUCT_NAME_SAVED.getMessage();
	private final String PRODUCT_DESCRIPTION_SAVED = Messages.PRODUCT_DESCRIPTION_SAVED.getMessage();
	private final String PRODUCT_PRICE_SAVED = Messages.PRODUCT_PRICE_SAVED.getMessage();
	private final String CHECKOUT_BTN_CLICKED = Messages.CHECKOUT_BTN_CLICKED.getMessage();
	private final String REMOVE_BTN_SAVED = Messages.REMOVE_BTN_SAVED.getMessage();
	private final String CHECKOUT_YOUR_INFORMATION_TXT_SAVED = Messages.CHECKOUT_YOUR_INFORMATION_TXT_SAVED.getMessage();
	private final String NAME_COMPLETED = Messages.NAME_COMPLETED.getMessage();
	private final String LASTNAME_COMPLETED = Messages.LASTNAME_COMPLETED.getMessage();
	private final String POSTAL_CODE_COMPLETED = Messages.POSTAL_CODE_COMPLETED.getMessage();
	private final String CHECKOUT_OVERVIEW_TXT_SAVED = Messages.CHECKOUT_OVERVIEW_TXT_SAVED.getMessage();
	private final String TAX_SAVED = Messages.TAX_SAVED.getMessage();
	private final String TOTAL_PRICE_SAVED = Messages.TOTAL_PRICE_SAVED.getMessage();
	private final String FINISH_BTN_CLICKED = Messages.FINISH_BTN_CLICKED.getMessage();
	private final String FINISH_MSG_SAVED = Messages.FINISH_MSG_SAVED.getMessage();
	private final String CHECKOUT_COMPLETED = Messages.CHECKOUT_COMPLETED.getMessage();
	private final String TOTAL_PRICE_ERROR = Messages.TOTAL_PRICE_ERROR.getMessage();
	private final String TOTAL_PRICE_OK = Messages.TOTAL_PRICE_OK.getMessage();
	private final String YOUR_CART_TXT_NOT_VISIBLE = Messages.YOUR_CART_TXT_NOT_VISIBLE.getMessage();
	private final String YOUR_CART_TXT_VISIBLE = Messages.YOUR_CART_TXT_VISIBLE.getMessage();
	private final String CHECKOUT_YOUR_INFORMATION_TXT_VISIBLE = Messages.CHECKOUT_YOUR_INFORMATION_TXT_VISIBLE.getMessage();
	private final String CHECKOUT_YOUR_INFORMATION_TXT_NOT_VISIBLE = Messages.CHECKOUT_YOUR_INFORMATION_TXT_NOT_VISIBLE.getMessage();
	private final String CHECKOUT_OVERVIEW_TXT_VISIBLE = Messages.CHECKOUT_OVERVIEW_TXT_VISIBLE.getMessage();
	private final String CHECKOUT_OVERVIEW_TXT_NOT_VISIBLE = Messages.CHECKOUT_OVERVIEW_TXT_NOT_VISIBLE.getMessage();
	private final String PURCHASE_MSG_OK = Messages.PURCHASE_MSG_OK.getMessage();
	private final String PURCHASE_MSG_ERROR = Messages.PURCHASE_MSG_ERROR.getMessage();
	
	// Messages Assertion
	private final String HANDLE_ASSERTION_ERROR = Messages.HANDLE_ASSERTION_ERROR.getMessage();
	
	// Data
	private String usr_actual = null;
	private String pass_actual = null;
	private String name_actual = null;
	private String lastname_actual = null;
	private String postal_code_actual = null;
	private String product_name_home_actual = null;
	private String product_name_cart_actual = null;
	private String product_description_home_actual = null;
	private String product_description_cart_actual = null;
	private String product_price_home_actual = null;
	private String product_price_cart_actual = null;
	private String product_name_checkout_actual = null;
	private String product_description_checkout_actual = null;
	private String product_price_checkout_actual = null;
	private Boolean is_remove_btn_clickable = false;
	private Boolean is_products_txt_visible = false;
	private Boolean is_your_cart_txt_visible = false;
	private String tax_actual = null;
	private String total_price_actual = null;
	private Boolean is_checkout_your_information_txt_visible = false;
	private Boolean is_checkout_overview_txt_visible = false;
	private String purchase_msg = null;

	// Reports
	private ExtentReports report = null;

	/*** METHODS ***/
	// Test Pre-Config
	@BeforeMethod
	public void configurateTest() {
		driver = Driver.configurate();

		report = Report.configurate();

		basePage = new BasePage(driver);
		basePage.navigateTo(URL);

		loginPage = new LoginPage();
		productsPage = new ProductsPage();
		cartPage = new CartPage();
		checkoutPage = new CheckoutPage();
		finishPage = new FinishPage();
		
	}
	
	// Testing Methods
	private void startTest(ExtentTest test) {
		test.log(Status.INFO, TEST_START);
		System.out.println(TEST_START + "\n");
		
	}
	
	private void finishTest(ExtentTest test, String usr) {
		test.log(Status.INFO, TEST_FINISH + "\nUsuario: " + usr);
		System.out.println(TEST_FINISH + "\nUsuario: " + usr + "\n");
		
	}
	
	private void login(ExtentTest test, String usr, String pass) {
		test.log(Status.INFO, LOGIN);
				
		loginPage.typeUsr(usr);
		usr_actual = loginPage.getUsrFldContent();
		test.log(Status.INFO, USR_COMPLETED);
		
		loginPage.typePass(pass);
		pass_actual = loginPage.getPassFldContent();
		test.log(Status.INFO, PASS_COMPLETED);
		
		loginPage.clickLoginBtn();
		test.log(Status.INFO, LOGIN_BTN_CLICKED);
				
		is_products_txt_visible = productsPage.isProductsTxtVisible();
		test.log(Status.INFO, PRODUCTS_TXT_SAVED);
		
		test.log(Status.INFO, LOGIN_COMPLETED);
		
	}
	
	private void cart(ExtentTest test) {
		test.log(Status.INFO, CART);
		
		productsPage.clickAddBtn();
		product_name_home_actual = productsPage.getProductNameText();
		test.log(Status.INFO, PRODUCT_ADDED);
		
		product_description_home_actual = productsPage.getProductDescriptionText();
		test.log(Status.INFO, PRODUCT_DESCRIPTION_SAVED);
		
		product_price_home_actual = productsPage.getProductPriceText();
		test.log(Status.INFO, PRODUCT_PRICE_SAVED);
		
		is_remove_btn_clickable = productsPage.isRemoveBtnClickable();
		test.log(Status.INFO, REMOVE_BTN_SAVED);
		
		productsPage.clickCartBtn();
		test.log(Status.INFO, CART_BTN_CLICKED);
		
		is_your_cart_txt_visible = cartPage.isYourCartTxtVisible();
		test.log(Status.INFO, YOUR_CART_TXT_SAVED);
		
		product_name_cart_actual = cartPage.getProductNameText();
		test.log(Status.INFO, PRODUCT_NAME_SAVED);
		
		product_description_cart_actual = cartPage.getProductDescriptionText();
		test.log(Status.INFO, PRODUCT_DESCRIPTION_SAVED);
		
		product_price_cart_actual = cartPage.getProductPriceText();
		test.log(Status.INFO, PRODUCT_PRICE_SAVED);
		
		cartPage.clickCheckoutBtn();
		test.log(Status.INFO, CHECKOUT_BTN_CLICKED);
		
		is_checkout_your_information_txt_visible = checkoutPage.isCheckoutYourInformationTxtVisible();
		test.log(Status.INFO, CHECKOUT_YOUR_INFORMATION_TXT_SAVED);
		
		test.log(Status.INFO, CART_COMPLETED);
	}
	
	private void checkout(ExtentTest test, String name, String lastname, String postal_code) {
		test.log(Status.INFO, CHECKOUT);
		
		checkoutPage.typeName(name);
		name_actual = checkoutPage.getNameFldContent();
		test.log(Status.INFO, NAME_COMPLETED);
		
		checkoutPage.typeLastname(lastname);
		lastname_actual = checkoutPage.getLastnameFldContent();
		test.log(Status.INFO, LASTNAME_COMPLETED);
		
		checkoutPage.typePostalCode(postal_code);
		postal_code_actual = checkoutPage.getPostalCodeFldContent();
		test.log(Status.INFO, POSTAL_CODE_COMPLETED);
		
		checkoutPage.clickCheckoutBtn();
		test.log(Status.INFO, CHECKOUT_BTN_CLICKED);
		
		is_checkout_overview_txt_visible = checkoutPage.isCheckoutOverviewTxtVisible();
		test.log(Status.INFO, CHECKOUT_OVERVIEW_TXT_SAVED);
		
		product_name_checkout_actual = checkoutPage.getProductNameText();
		test.log(Status.INFO, PRODUCT_NAME_SAVED);
		
		product_description_checkout_actual = checkoutPage.getProductDescriptionText();
		test.log(Status.INFO, PRODUCT_DESCRIPTION_SAVED);
		
		product_price_checkout_actual = checkoutPage.getProductPriceText();
		test.log(Status.INFO, PRODUCT_PRICE_SAVED);
		
		tax_actual = checkoutPage.getTaxText();
		test.log(Status.INFO, TAX_SAVED);
		
		total_price_actual = checkoutPage.getTotalText();
		test.log(Status.INFO, TOTAL_PRICE_SAVED);
		
		checkoutPage.clickFinishBtn();
		test.log(Status.INFO, FINISH_BTN_CLICKED);
		
		purchase_msg = finishPage.getPurchaseMsgText();
		test.log(Status.INFO, FINISH_MSG_SAVED);
		
		test.log(Status.INFO, CHECKOUT_COMPLETED);
	}
	
	private void validateLogin(ExtentTest test, String usr, String pass) {
		test.log(Status.INFO, VALIDATE_LOGIN);
		
		assertEquals(usr_actual, usr, USR_MISMATCH);
		test.pass(USR_MATCH);
		
		assertEquals(pass_actual, pass, PASS_MISMATCH);
		test.pass(PASS_MATCH);
	
		assertTrue(is_products_txt_visible, PRODUCTS_TXT_NOT_VISIBLE);
		test.pass(PRODUCTS_TXT_VISIBLE);
				
		test.pass(LOGIN_OK);
		System.out.println(LOGIN_OK + "\nUsuario: " + usr + "\n");
		
	}
	
	private void validateCart(ExtentTest test, String product_name) {
		test.log(Status.INFO, VALIDATE_CART);
		
		assertTrue(is_remove_btn_clickable, REMOVE_BTN_NOT_CLICKABLE);
		test.pass(REMOVE_BTN_CLICKABLE);
		
		assertTrue(is_your_cart_txt_visible, YOUR_CART_TXT_NOT_VISIBLE);
		test.pass(YOUR_CART_TXT_VISIBLE);
		
		assert product_name_home_actual.equals(product_name_cart_actual) && product_name_cart_actual.equals(product_name) : PRODUCT_NAME_MISMATCH;
		test.pass(PRODUCT_NAME_MATCH);
		
		assertEquals(product_description_home_actual, product_description_cart_actual, PRODUCT_DESCRIPTION_MISMATCH);
		test.pass(PRODUCT_DESCRIPTION_MATCH);
		
		assertEquals(product_price_home_actual, product_price_cart_actual, PRODUCT_PRICE_MISMATCH);
		test.pass(PRODUCT_PRICE_MATCH);
		
		//VER SI PODEMOS CONVERTIR ESTO A UN OBJETO DE LA CLASE PRODUCTO (NOMBRE, PRECIO, DESCRIPCION)
				
		test.pass(CART_OK);
		System.out.println(CART_OK + "\nProducto: " + product_name + "\n");
		
	}
	
	private void validateCheckout(ExtentTest test, String name, String lastname, String postal_code, String product_name) {
		test.log(Status.INFO, VALIDATE_CHECKOUT);
		
		assertTrue(is_checkout_your_information_txt_visible, CHECKOUT_YOUR_INFORMATION_TXT_NOT_VISIBLE);
		test.pass(CHECKOUT_YOUR_INFORMATION_TXT_VISIBLE);
		
		assertEquals(name_actual, name, NAME_MISMATCH);
		test.pass(NAME_MATCH);
		
		assertEquals(lastname_actual, lastname, LASTNAME_MISMATCH);
		test.pass(LASTNAME_MATCH);
		
		assertEquals(postal_code_actual, postal_code, POSTAL_CODE_MISMATCH);
		test.pass(POSTAL_CODE_MATCH);
		
		assertTrue(is_checkout_overview_txt_visible, CHECKOUT_OVERVIEW_TXT_NOT_VISIBLE);
		test.pass(CHECKOUT_OVERVIEW_TXT_VISIBLE);
		
		assert product_name_cart_actual.equals(product_name_checkout_actual) && product_name_checkout_actual.equals(product_name) : PRODUCT_NAME_MISMATCH;
		test.pass(PRODUCT_NAME_MATCH);
		
		assertEquals(product_description_cart_actual, product_description_checkout_actual, PRODUCT_DESCRIPTION_MISMATCH);
		test.pass(PRODUCT_DESCRIPTION_MATCH);
		
		assertEquals(product_price_cart_actual, product_price_checkout_actual, PRODUCT_PRICE_MISMATCH);
		test.pass(PRODUCT_PRICE_MATCH);
		
		assertEquals(Double.parseDouble(product_price_checkout_actual) + Double.parseDouble(tax_actual), Double.parseDouble(total_price_actual), TOTAL_PRICE_ERROR);
		test.pass(TOTAL_PRICE_OK);
		
	//	assertEquals(purchase_msg, PURCHASE_MSG_ERROR);
	//	test.pass(PURCHASE_MSG_OK);
				
		test.pass(CHECKOUT_OK);
		System.out.println(CHECKOUT_OK + "\nNombre: " + name + " " + lastname + "\n");
		
	}
	
	private void validateTest(ExtentTest test, String usr, String pass, String name, String lastname, String postal_code, String product_name) {
		test.log(Status.INFO, VALIDATE_TEST);
		
		validateLogin(test, usr, pass);
		validateCart(test, product_name);
		validateCheckout(test, name, lastname, postal_code, product_name);
				
		test.pass(TEST_OK);
		System.out.println(TEST_OK + "\n");
		
	}
	
	private void handleAssertionError(ExtentTest test, AssertionError e) {
		test.log(Status.INFO, HANDLE_ASSERTION_ERROR);
		
		test.addScreenCaptureFromPath("screenshot.png");
		
		test.fail(TEST_ERROR + " \nERROR: " + e.getMessage());
		System.out.println(TEST_ERROR + " \nERROR: " + e.getMessage() + "\n");
		
	}

	// Tests
	@Test(dataProvider = "Purchase", dataProviderClass = Data.class, priority = 1)
	public void purchase(String usr, String pass, String name, String lastname, String postal_code, String product_name) {
		ExtentTest test = report.createTest("E2E Checkout Test");
		
		startTest(test);
		
		login(test, usr, pass);
		
		cart(test);
		
		checkout(test, name, lastname, postal_code);
		
		try {
			validateTest(test, usr, pass, name, lastname, postal_code, product_name);
			
		} catch (AssertionError e) {
			handleAssertionError(test, e);
			
		} finally {
			finishTest(test, usr);
			
		}
		
	}

	
	// Test Post-Config
	@AfterMethod
	public void finishTest() {
		report.flush();

		Driver.finish();
		
	}
}